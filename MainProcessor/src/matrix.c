/*
* matrix.c
*/

#include "../inc/matrix.h"
#include "../inc/spi.h"
#include <stdint.h>
#include <string.h>
#include <avr/io.h>
#include <util/delay.h>

uint8_t buffer[NUM_MATRICIES*NUM_COLUMNS];
uint8_t queue[QUEUE_MAX_SIZE];
int queue_front;
int queue_rear;
int queue_count;

char const ascii_table[NUM_CHARS][CHAR_LENGTH] PROGMEM = {
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000}, 	// space
	{0b00000000, 0b00000000, 0b00000000, 0b11111011, 0b11111011, 0b00000000, 0b00000000, 0b00000000},	// !
	{0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000},	// "
	{0b00000000, 0b00100100, 0b11111111, 0b00100100, 0b00100100, 0b11111111, 0b00100100, 0b00000000},	// #
	{0b00000000, 0b00110010, 0b11111111, 0b01001001, 0b11111111, 0b00100110, 0b00000000, 0b00000000},	// $
	{0b00000000, 0b01100001, 0b01100010, 0b00000100, 0b00001000, 0b00010011, 0b00100011, 0b00000000},	// %
	{0b00000000, 0b01100110, 0b10011001, 0b10011001, 0b01100110, 0b00000110, 0b00001001, 0b00000000},	// &
	{0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000},	// '
	{0b00000000, 0b00011000, 0b01100110, 0b10000001, 0b10000001, 0b00000000, 0b00000000, 0b00000000},	// (
	{0b00000000, 0b00000000, 0b00000000, 0b10000001, 0b10000001, 0b01100110, 0b00011000, 0b00000000},	// )
	{0b00000000, 0b01001000, 0b00110000, 0b01111000, 0b00110000, 0b01001000, 0b00000000, 0b00000000},	// *
	{0b00000000, 0b00001100, 0b00001100, 0b00111111, 0b00111111, 0b00001100, 0b00001100, 0b00000000},	// +
	{0b00000000, 0b00000000, 0b00000001, 0b00000111, 0b00000110, 0b00000000, 0b00000000, 0b00000000},	// ,
	{0b00000000, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00000000, 0b00000000},	// -
	{0b00000000, 0b00000000, 0b00000000, 0b00000011, 0b00000011, 0b00000000, 0b00000000, 0b00000000},	// .
	{0b00000000, 0b00000001, 0b00000010, 0b00000100, 0b00001000, 0b00010000, 0b00100000, 0b00000000},	// /
	{0b00000000, 0b00000000, 0b00111110, 0b01000101, 0b01001001, 0b00111110, 0b00000000, 0b00000000},	// 0
	{0b00000000, 0b00000000, 0b00010001, 0b00100001, 0b01111111, 0b00000001, 0b00000000, 0b00000000},	// 1
	{0b00000000, 0b00000000, 0b00100011, 0b01000101, 0b01000101, 0b01001001, 0b00110001, 0b00000000},	// 2
	{0b00000000, 0b00000000, 0b01000001, 0b01001001, 0b01001001, 0b01111111, 0b00000000, 0b00000000},	// 3
	{0b00000000, 0b01111000, 0b00001000, 0b00001000, 0b01111111, 0b00001000, 0b00000000, 0b00000000},	// 4
	{0b00000000, 0b00000000, 0b01111001, 0b01001001, 0b01001001, 0b01000110, 0b00000000, 0b00000000},	// 5
	{0b00000000, 0b00111110, 0b01001001, 0b01001001, 0b00100110, 0b00000000, 0b00000000, 0b00000000},	// 6
	{0b00000000, 0b01000001, 0b01000010, 0b01000100, 0b01001000, 0b01010000, 0b01100000, 0b00000000},	// 7
	{0b00000000, 0b00000000, 0b00110110, 0b01001001, 0b01001001, 0b00110110, 0b00000000, 0b00000000},	// 8
	{0b00000000, 0b00000000, 0b00110010, 0b01001001, 0b01001001, 0b00111110, 0b00000000, 0b00000000},	// 9
	{0b00000000, 0b00000000, 0b00000000, 0b00110110, 0b00110110, 0b00000000, 0b00000000, 0b00000000},	// :
	{0b00000000, 0b00000000, 0b00000001, 0b00110111, 0b00110110, 0b00000000, 0b00000000, 0b00000000},	// ;
	{0b00000000, 0b00011000, 0b00100100, 0b11000011, 0b10000001, 0b00000000, 0b00000000, 0b00000000},	// <
	{0b00000000, 0b00000000, 0b00010100, 0b00010100, 0b00010100, 0b00010100, 0b00000000, 0b00000000},	// =
	{0b00000000, 0b00000000, 0b00000000, 0b10000001, 0b11000011, 0b00100100, 0b00011000, 0b00000000},	// >
	{0b00000000, 0b00000000, 0b00110000, 0b01000000, 0b01001101, 0b00111000, 0b00000000, 0b00000000},	// ?
	{0b00111110, 0b01000001, 0b01011101, 0b01010011, 0b01011101, 0b01000010, 0b00111110, 0b00000000},	// @
	{0b00000000, 0b00001111, 0b00111000, 0b01001000, 0b01001000, 0b00111000, 0b00001111, 0b00000000},	// A
	{0b00000000, 0b01111111, 0b01001001, 0b01001001, 0b00110110, 0b00000000, 0b00000000, 0b00000000},	// B
	{0b00000000, 0b00011100, 0b00100010, 0b01000001, 0b01000001, 0b00000000, 0b00000000, 0b00000000},	// C
	{0b00000000, 0b01111111, 0b01000001, 0b01000001, 0b00100001, 0b00011110, 0b00000000, 0b00000000},	// D
	{0b00000000, 0b01111111, 0b01001001, 0b01001001, 0b01000001, 0b00000000, 0b00000000, 0b00000000},	// E
	{0b00000000, 0b01111111, 0b01001000, 0b01001000, 0b01000000, 0b00000000, 0b00000000, 0b00000000},	// F
	{0b00000000, 0b00111110, 0b01000001, 0b01000001, 0b01001001, 0b00101110, 0b00001000, 0b00000000},	// G
	{0b00000000, 0b01111111, 0b00001000, 0b00001000, 0b00001000, 0b01111111, 0b00000000, 0b00000000},	// H
	{0b00000000, 0b01000001, 0b01000001, 0b01111111, 0b01111111, 0b01000001, 0b01000001, 0b00000000},	// I
	{0b00000000, 0b00000000, 0b01000010, 0b01000001, 0b01000001, 0b01111110, 0b01000000, 0b00000000},	// J
	{0b00000000, 0b01111111, 0b00001000, 0b00010100, 0b00100010, 0b01000001, 0b00000000, 0b00000000},	// K
	{0b00000000, 0b01111111, 0b00000001, 0b00000001, 0b00000001, 0b00000001, 0b00000000, 0b00000000},	// L
	{0b00000000, 0b00011111, 0b01100000, 0b00010000, 0b01100000, 0b00011111, 0b00000000, 0b00000000},	// M
	{0b00000000, 0b01111111, 0b00100000, 0b00010000, 0b00001000, 0b00000100, 0b01111111, 0b00000000},	// N
	{0b00000000, 0b00111110, 0b01000001, 0b01000001, 0b01000001, 0b00111110, 0b00000000, 0b00000000},	// O
	{0b00000000, 0b01111111, 0b01000100, 0b01000100, 0b01000100, 0b00111000, 0b00000000, 0b00000000},	// P
	{0b00000000, 0b00111110, 0b01000001, 0b01000001, 0b01000010, 0b00111101, 0b00000000, 0b00000000},	// Q
	{0b00000000, 0b01111111, 0b01001000, 0b01001000, 0b00110110, 0b00000001, 0b00000000, 0b00000000},	// R
	{0b00000000, 0b00110010, 0b01001001, 0b01001001, 0b01001001, 0b00100110, 0b00000000, 0b00000000},	// S
	{0b00000000, 0b01000000, 0b01000000, 0b01111111, 0b01111111, 0b01000000, 0b01000000, 0b00000000},	// T
	{0b00000000, 0b01111110, 0b00000001, 0b00000001, 0b00000001, 0b00000001, 0b01111110, 0b00000000},	// U
	{0b00000000, 0b01110000, 0b00001100, 0b00000011, 0b00000011, 0b00001100, 0b01110000, 0b00000000},	// V
	{0b00000000, 0b01111110, 0b00000001, 0b00000110, 0b00000110, 0b00000001, 0b01111110, 0b00000000},	// W
	{0b00000000, 0b01100011, 0b00010100, 0b00001000, 0b00001000, 0b00010100, 0b01100011, 0b00000000},	// X
	{0b00000000, 0b01100000, 0b00010000, 0b00001111, 0b00001111, 0b00010000, 0b01100000, 0b00000000},	// Y
	{0b00000000, 0b01000001, 0b01000011, 0b01000101, 0b01001001, 0b01010001, 0b01100001, 0b00000000},	// Z
	{0b00000000, 0b11111111, 0b10000001, 0b10000001, 0b00000000, 0b00000000, 0b00000000, 0b00000000},	// [
	{0b00000000, 0b01000000, 0b00110000, 0b00001000, 0b00000100, 0b00000010, 0b00000001, 0b00000000},	// "\"
	{0b00000000, 0b10000001, 0b10000001, 0b11111111, 0b00000000, 0b00000000, 0b00000000, 0b00000000},	// ]
	{0b00000000, 0b00100000, 0b01000000, 0b10000000, 0b01000000, 0b00100000, 0b00000000, 0b00000000},	// ^
	{0b00000000, 0b00000000, 0b00000001, 0b00000001, 0b00000001, 0b00000001, 0b00000000, 0b00000000},	// _
	{0b00000000, 0b00000000, 0b10000000, 0b01000000, 0b00100000, 0b00000000, 0b00000000, 0b00000000},	// `
	{0b00000000, 0b00100110, 0b01001001, 0b01001001, 0b00100110, 0b00011111, 0b00000000, 0b00000000},	// a
	{0b00000000, 0b01111111, 0b00001001, 0b00001001, 0b00000110, 0b00000000, 0b00000000, 0b00000000},	// b 
	{0b00000000, 0b00001100, 0b00010010, 0b00100001, 0b00100001, 0b00000000, 0b00000000, 0b00000000},	// c
	{0b00000000, 0b00000110, 0b00001001, 0b00001001, 0b01111111, 0b00000000, 0b00000000, 0b00000000},	// d
	{0b00000000, 0b00011110, 0b00101001, 0b00101001, 0b00101001, 0b00011010, 0b00000000, 0b00000000},	// e
	{0b00000000, 0b00001000, 0b00111111, 0b01001000, 0b01000000, 0b00100000, 0b00000000, 0b00000000},	// f
	{0b00000000, 0b00110010, 0b01001001, 0b01010001, 0b00111110, 0b00000000, 0b00000000, 0b00000000},	// g
	{0b00000000, 0b01111111, 0b00001000, 0b00001000, 0b00000111, 0b00000000, 0b00000000, 0b00000000},	// h	
	{0b00000000, 0b00000001, 0b00001001, 0b00101111, 0b00000001, 0b00000000, 0b00000000, 0b00000000},	// i
	{0b00000000, 0b00000010, 0b00000001, 0b00000001, 0b00101110, 0b00000000, 0b00000000, 0b00000000},	// j
	{0b00000000, 0b00111111, 0b00000100, 0b00001010, 0b00010001, 0b00000000, 0b00000000, 0b00000000},	// k
	{0b00000000, 0b00000000, 0b00000001, 0b01000001, 0b01111111, 0b00000001, 0b00000000, 0b00000000},	// l
	{0b00000000, 0b00000111, 0b00011000, 0b00000100, 0b00011000, 0b00000111, 0b00000000, 0b00000000},	// m
	{0b00000000, 0b00011111, 0b00001000, 0b00001000, 0b00000111, 0b00000000, 0b00000000, 0b00000000},	// n
	{0b00000000, 0b00001110, 0b00010001, 0b00010001, 0b00010001, 0b00001110, 0b00000000, 0b00000000},	// o
	{0b00000000, 0b00111111, 0b00100100, 0b00100100, 0b00011000, 0b00000000, 0b00000000, 0b00000000},	// p
	{0b00000000, 0b00110000, 0b01001000, 0b01001000, 0b00111111, 0b00000010, 0b00000000, 0b00000000},	// q
	{0b00000000, 0b00111111, 0b00010000, 0b00100000, 0b00100000, 0b00010000, 0b00000000, 0b00000000},	// r
	{0b00000000, 0b00011000, 0b00100101, 0b00100101, 0b00100101, 0b00010010, 0b00000000, 0b00000000},	// s
	{0b00000000, 0b00010000, 0b00010000, 0b01111111, 0b01111111, 0b00010000, 0b00010000, 0b00000000},	// t
	{0b00000000, 0b00111110, 0b00000001, 0b00000001, 0b00000001, 0b00111110, 0b00000001, 0b00000000},	// u
	{0b00000000, 0b00111000, 0b00000110, 0b00000001, 0b00000001, 0b00000110, 0b00111000, 0b00000000},	// v
	{0b00000000, 0b00111100, 0b00000011, 0b00000100, 0b00000011, 0b00111100, 0b00000000, 0b00000000},	// w
	{0b00000000, 0b00100001, 0b00010010, 0b00001100, 0b00001100, 0b00010010, 0b00100001, 0b00000000},	// x
	{0b00000000, 0b00000000, 0b00110010, 0b00001001, 0b00001001, 0b00111110, 0b00000000, 0b00000000},	// y
	{0b00000000, 0b00100001, 0b00100011, 0b00100101, 0b00101001, 0b00110001, 0b00000000, 0b00000000},	// z
	{0b00000000, 0b00011000, 0b00111100, 0b11100111, 0b10000001, 0b00000000, 0b00000000, 0b00000000},	// {
	{0b00000000, 0b00000000, 0b00000000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, 0b00000000},	// |
	{0b00000000, 0b00000000, 0b00000000, 0b10000001, 0b11000011, 0b00111100, 0b00011000, 0b00000000},	// }
	{0b00000000, 0b00100000, 0b01000000, 0b00100000, 0b01000000, 0b00000000, 0b00000000, 0b00000000}	// ~
};


//queue functions
uint8_t queue_is_empty(void){
	return queue_count == 0;
}

uint8_t queue_is_full(void){
	return queue_count == QUEUE_MAX_SIZE;
}

int queue_size(void){
	return queue_count;
}

uint8_t queue_peek(void){
	return queue[queue_front];
}

void queue_clear(void){
	//set queue to empty 
	queue_front = 0;
	queue_rear = -1;
	queue_count = 0;
}

uint8_t queue_pop(void){
	
	uint8_t to_return = queue[queue_front++];
	
	if (queue_front == QUEUE_MAX_SIZE){
		queue_front = 0;
	}
	
	queue_count--;
	return to_return;
}

void queue_insert(uint8_t val){
	if (queue_is_full()){
		return;
	}
	
	if (queue_rear == QUEUE_MAX_SIZE - 1){
		queue_rear = -1;
	}
	
	queue[++queue_rear] = val;
	queue_count++;
}

void matrix_init(void){
	
	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// intensity register, set brightness level to lowest
		spi_write_register(0x0A, 0x00);
	}
	spi_set_ss();

	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// scan-limit register, columns 0-7
		spi_write_register(0x0B, 0x07);
	}
	spi_set_ss();

	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// shutdown register, normal operation mode
		spi_write_register(0x0C, 0x01);
	}
	spi_set_ss();
	
}

void matrix_clear(void){
	
	for (uint8_t i = 0x01; i < (NUM_COLUMNS + 1); i++){
		spi_clear_ss();
		for (uint8_t j = 0x00; j < NUM_MATRICIES; j++){
			spi_write_register(i, 0x00);
		}
		spi_set_ss();
	}

	buffer_clear();
}

// set all buffer values to 0x00
void buffer_init(void){
	
	for(uint8_t i = 0x00; i < NUM_MATRICIES*NUM_COLUMNS; i++){
		buffer[i] = 0x00;
	}
	
	//initialize queue to empty 
	queue_front = 0;
	queue_rear = -1;
	queue_count = 0;
	
}

// set all buffer values to 0x00
void buffer_clear(void){
	
	for(uint8_t i = 0x00; i < NUM_MATRICIES*NUM_COLUMNS; i++){
		buffer[i] = 0x00;
	}
	
	//set queue to empty 
	queue_front = 0;
	queue_rear = -1;
	queue_count = 0;
}


void buffer_shift(void){
	if (!queue_is_empty()){
		uint8_t to_add = queue_pop();
		for(uint8_t i = 0; i < (NUM_COLUMNS*NUM_MATRICIES) - (NUM_MATRICIES-1)*NUM_COLUMNS; i++){
			buffer[i]= (buffer[i] >> 1) | (to_add << 7);
			to_add = to_add >> 1;			
		}		

	} else {
		for(uint8_t i = 0; i < (NUM_COLUMNS*NUM_MATRICIES) - (NUM_MATRICIES-1)*NUM_COLUMNS; i++){
			buffer[i]= (buffer[i] >> 1);
		}			
	}	

	for(uint8_t i = (NUM_COLUMNS*NUM_MATRICIES) - (NUM_MATRICIES-1)*NUM_COLUMNS; i < (NUM_COLUMNS*NUM_MATRICIES); i++){
		buffer[i]= (buffer[i] >> 1) | (buffer[i-NUM_COLUMNS] << 7);
	}

}


void  matrix_push_char(char val){
	for (uint8_t i = 0; i < CHAR_LENGTH; i++){
		queue_insert((pgm_read_byte_near(&ascii_table[val - 32][i])));
	}
}

void matrix_push_str(char * val){
		
	for (uint8_t i = 0; i < strlen(val); i++){
		matrix_push_char((val[i]));
	}
}

void matrix_display_buffer(void){
	for (uint8_t i = 0x00; i < NUM_MATRICIES; i++){
		for (uint8_t j = 0x01; j < NUM_COLUMNS+1; j++){
		
			spi_clear_ss();			
			for (uint8_t k = 0x00; k < i; k++){
				spi_write_register(0x00, 0x00);
			}
						
			spi_write_register(j, buffer[j + i * NUM_COLUMNS - 1]);
						
			for (uint8_t k = NUM_MATRICIES-1; k > i; k--){
				spi_write_register(0x00, 0x00);
			}
						
			spi_set_ss();
						
		}
					
	}
	
	_delay_ms(MATRIX_TRANSMIT_DELAY);
	
}
