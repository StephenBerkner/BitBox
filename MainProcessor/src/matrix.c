/*
* matrix.c
*/

#include "../inc/matrix.h"
#include "../inc/spi.h"

#include <stdint.h>
#include <avr/io.h>
#include <util/delay.h>

#define TRANSMIT_DELAY_MS 200

uint8_t buffer[NUM_MATRICIES*NUM_COLUMNS];


char const ascii_table[NUM_CHARS][CHAR_LENGTH] PROGMEM = {
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000}, // space  
	{0b00011000, 0b00011000, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000}, // !      
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01100110, 0b01100110}, // "      
	{0b00100100, 0b00100100, 0b11111111, 0b00100100, 0b00100100, 0b11111111, 0b00100100, 0b00100100}, // #      
	{0b00011000, 0b00101100, 0b00101000, 0b00011000, 0b00001100, 0b00101100, 0b00011000, 0b00001000}, // $      
	{0b00000000, 0b01100010, 0b01100100, 0b00001000, 0b00010000, 0b00100110, 0b01000110, 0b00000000}, // %
	{0b10001100, 0b01010010, 0b00100100, 0b01011100, 0b10010010, 0b00100010, 0b00011100, 0b00000000}, // & 
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00011000, 0b00011000}, // '
	{0b00010000, 0b00001000, 0b00000100, 0b00000010, 0b00000010, 0b00000100, 0b00001000, 0b00010000}, // (
	{0b00001000, 0b00010000, 0b00100000, 0b01000000, 0b01000000, 0b00100000, 0b00010000, 0b00001000}, // )
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00010100, 0b00001000, 0b00010100, 0b00000000}, // *
	{0b00000000, 0b00000000, 0b00001000, 0b00001000, 0b00111110, 0b00001000, 0b00001000, 0b00000000}, // +
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00011000, 0b00110000, 0b00110000}, //
	{0b00000000, 0b00000000, 0b00000000, 0b00111100, 0b00111100, 0b00000000, 0b00000000, 0b00000000}, // -
	{0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000}, // .
	{0b00000010, 0b00000110, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b01000000, 0b00000000}, // /
	{0b00011000, 0b00100100, 0b00101100, 0b00110100, 0b00100100, 0b00100100, 0b00011000, 0b00000000}, // 0
	{0b01111110, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00010100, 0b00011000, 0b00010000}, // 1 
	{0b01111110, 0b00001100, 0b00011000, 0b00110000, 0b01000000, 0b01000010, 0b00100100, 0b00011000}, // 2 
	{0b00011100, 0b00100010, 0b00100000, 0b00111000, 0b00100000, 0b00100000, 0b00100010, 0b00011100}, // 3
	{0b00100000, 0b00100000, 0b00100000, 0b01111110, 0b00100010, 0b00100100, 0b00101000, 0b00110000}, // 4
	{0b00011100, 0b00100000, 0b00100000, 0b00011100, 0b00000100, 0b00000100, 0b00111100, 0b00000000}, // 5
	{0b00111100, 0b01000010, 0b01000010, 0b00111110, 0b00000010, 0b00000010, 0b01000010, 0b00111100}, // 6
	{0b00000010, 0b00000110, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b01000000, 0b01111110}, // 7
	{0b00111100, 0b01000010, 0b01000010, 0b00111100, 0b01000010, 0b01000010, 0b01000010, 0b00111100}, // 8
	{0b00111100, 0b01000010, 0b01000000, 0b01000000, 0b01111100, 0b01000010, 0b01000010, 0b00111100}, // 9
	{0b00000000, 0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00011000, 0b00011000, 0b00000000}, // :
	{0b00001100, 0b00011000, 0b00011000, 0b00011000, 0b00000000, 0b00011000, 0b00011000, 0b00000000}, // ;
	{0b00110000, 0b00011000, 0b00001100, 0b00000110, 0b00000110, 0b00001100, 0b00011000, 0b00110000}, // <
	{0b00000000, 0b00111100, 0b00111100, 0b00000000, 0b00111100, 0b00111100, 0b00000000, 0b00000000}, // =
	{0b00000100, 0b00011000, 0b00110000, 0b01100000, 0b01100000, 0b00110000, 0b00011000, 0b00000100}, // >
	{0b00001000, 0b00000000, 0b00001000, 0b00001000, 0b00010000, 0b00100000, 0b00100100, 0b00011000}, // ?
	{0b00011100, 0b01100010, 0b10111001, 0b10100101, 0b10100101, 0b10011001, 0b01000010, 0b00111100}, // @
	{0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b01111110, 0b01000010, 0b00100100, 0b00011000}, // A
	{0b00011110, 0b00100010, 0b00100010, 0b00011110, 0b00100010, 0b00100010, 0b00100010, 0b00011110}, // B
	{0b00111000, 0b00000100, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000100, 0b00111000}, // C
	{0b00011110, 0b00100010, 0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b00100010, 0b00011110}, // D
	{0b00111110, 0b00000010, 0b00000010, 0b00000010, 0b00011110, 0b00000010, 0b00000010, 0b00111110}, // E
	{0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00011110, 0b00000010, 0b00000010, 0b00111110}, // F
	{0b00011000, 0b00100100, 0b00100010, 0b01110010, 0b00000010, 0b00100010, 0b00100100, 0b00011000}, // G
	{0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b01111110, 0b01000010, 0b01000010, 0b01000010}, // H
	{0b01111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b01111110}, // I
	{0b00011000, 0b00100100, 0b00100100, 0b00100000, 0b00100000, 0b00100000, 0b00100000, 0b01111110}, // J
	{0b00100010, 0b00010010, 0b00001010, 0b00000110, 0b00000110, 0b00001010, 0b00010010, 0b00100010}, // K
	{0b01111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010}, // L
	{0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b01011010, 0b01011010, 0b00100100, 0b00100100}, // M
	{0b01000010, 0b01100010, 0b01110010, 0b01011010, 0b01001010, 0b01001110, 0b01000110, 0b01000010}, // N
	{0b00011000, 0b00100100, 0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b00100100, 0b00011000}, // O
	{0b00000010, 0b00000010, 0b00000010, 0b00011110, 0b00100010, 0b00100010, 0b00100010, 0b00011110}, // P
	{0b01011100, 0b00100010, 0b00110010, 0b00100010, 0b00100010, 0b00100010, 0b00100010, 0b00011100}, // Q
	{0b00110010, 0b00011010, 0b00001110, 0b00011110, 0b00100010, 0b00100010, 0b00100010, 0b00011110}, // R
	{0b00011100, 0b00100010, 0b00100000, 0b00011100, 0b00000110, 0b00100010, 0b00100010, 0b00011100}, // S
	{0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b01111110}, // T
	{0b00011000, 0b00100100, 0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b01000010, 0b01000010}, // U
	{0b00011000, 0b00011000, 0b00100100, 0b00100100, 0b00100100, 0b01000010, 0b01000010, 0b01000010}, // V
	{0b00100100, 0b00111100, 0b01011010, 0b01011010, 0b01000010, 0b01000010, 0b01000010, 0b01000010}, // W
	{0b01000010, 0b01100110, 0b00100100, 0b00011000, 0b00100100, 0b00100100, 0b01000010, 0b01000010}, // X
	{0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00100100, 0b00100100, 0b01000010, 0b01000010}, // Y
	{0b01111110, 0b00000010, 0b00000100, 0b00001000, 0b00010000, 0b00100000, 0b01000000, 0b01111110}, // Z
	{0b00011110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00011110}, // [
	{0b01000000, 0b01110000, 0b00110000, 0b00011000, 0b00001100, 0b00001100, 0b00000110, 0b00000010}, // "\"
	{0b01111000, 0b01000000, 0b01000000, 0b01000000, 0b01000000, 0b01000000, 0b01000000, 0b01111000}, // ]
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00100100, 0b00011000}, // ^
	{0b00111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000}, // _
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00010000, 0b00001000}, // `
	{0b00101100, 0b00110010, 0b00110010, 0b00111100, 0b00100000, 0b00011100, 0b00000000, 0b00000000}, // a
	{0b00001110, 0b00010010, 0b00010010, 0b00001110, 0b00000010, 0b00000010, 0b00000010, 0b00000000}, // b
	{0b00111000, 0b00000100, 0b00000010, 0b00000010, 0b00000100, 0b00111000, 0b00000000, 0b00000000}, // c
	{0b01011000, 0b01100100, 0b01100100, 0b01011000, 0b01000000, 0b01000000, 0b01000000, 0b00000000}, // d
	{0b00111000, 0b01000100, 0b00000010, 0b01111110, 0b01000010, 0b00100100, 0b00011000, 0b00000000}, // e
	{0b00000100, 0b00000100, 0b00000100, 0b00000100, 0b00011110, 0b00000100, 0b00100100, 0b00011000}, // f
	{0b00111000, 0b01000100, 0b01000000, 0b01011000, 0b01100100, 0b01000100, 0b00111000, 0b00000000}, // g
	{0b00100100, 0b00100100, 0b00100100, 0b00011100, 0b00000100, 0b00000100, 0b00000100, 0b00000100}, // h
	{0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00000000, 0b00011000, 0b00011000, 0b00000000}, // i
	{0b00011000, 0b00100100, 0b00100000, 0b00100000, 0b00000000, 0b00100000, 0b00000000, 0b00000000}, // j
	{0b01000100, 0b00100100, 0b00010100, 0b00001100, 0b00010100, 0b00100100, 0b00000100, 0b00000000}, // k
	{0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00000000}, // l
	{0b01000010, 0b01000010, 0b01000010, 0b01011010, 0b01011010, 0b01100110, 0b00000000, 0b00000000}, // m
	{0b00100100, 0b00100100, 0b00100100, 0b00100100, 0b00011100, 0b00000000, 0b00000000, 0b00000000}, // n
	{0b00011000, 0b00100100, 0b00100100, 0b00100100, 0b00011000, 0b00000000, 0b00000000, 0b00000000}, // o
	{0b00000100, 0b00000100, 0b00011100, 0b00100100, 0b00100100, 0b00011100, 0b00000000, 0b00000000}, // p
	{0b00100000, 0b01100000, 0b00100000, 0b00111000, 0b00100100, 0b00100100, 0b00011000, 0b00000000}, // q
	{0b00000010, 0b00000010, 0b00000010, 0b00100110, 0b00011010, 0b00000000, 0b00000000, 0b00000000}, // r
	{0b00011100, 0b00100010, 0b00010000, 0b00001100, 0b00100010, 0b00011100, 0b00000000, 0b00000000}, // s
	{0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b01111110, 0b00011000, 0b00011000, 0b00000000}, // t
	{0b00011000, 0b00100100, 0b01000010, 0b01000010, 0b01000010, 0b00000000, 0b00000000, 0b00000000}, // u
	{0b00011000, 0b00011000, 0b00100100, 0b01000010, 0b01000010, 0b01000010, 0b00000000, 0b00000000}, // v
	{0b00100100, 0b01011010, 0b01011010, 0b01000010, 0b00000000, 0b00000000, 0b00000000, 0b00000000}, // w
	{0b01000010, 0b00100100, 0b00011000, 0b00011000, 0b00100100, 0b01000010, 0b00000000, 0b00000000}, // x
	{0b00111100, 0b01000010, 0b01000000, 0b01011100, 0b01100010, 0b01100010, 0b00000000, 0b00000000}, // y
	{0b01111100, 0b00000100, 0b00111000, 0b01000000, 0b01111100, 0b00000000, 0b00000000, 0b00000000}, // z
	{0b01100000, 0b00100000, 0b00010000, 0b00001000, 0b00001000, 0b00010000, 0b00100000, 0b01100000}, // {
	{0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000, 0b00001000}, // |
	{0b00000110, 0b00000100, 0b00001000, 0b00010000, 0b00010000, 0b00001000, 0b00000100, 0b00000110}, // }
	{0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00010000, 0b00101010, 0b00000100, 0b00000000}  // ~
};

// Matrix functions 
void matrix_init(void){
	
	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// intensity register, set brightness level
		spi_write_register(0x0A, 0x00);
	}
	spi_set_ss();

	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// scan-limit register, columns 0-7
		spi_write_register(0x0B, 0x07);
	}
	spi_set_ss();

	spi_clear_ss();
	for (uint8_t i = 0; i < NUM_MATRICIES; i++){
		// shutdown register, normal operation mode
		spi_write_register(0x0C, 0x01);
	}
	spi_set_ss();
	
}

void matrix_clear(void){
	
	for (uint8_t i = 0x01; i < (NUM_COLUMNS + 1); i++){
		spi_clear_ss();
		for (uint8_t j = 0x00; j < NUM_MATRICIES; j++){
			spi_write_register(i, 0x00);
		}
		spi_set_ss();
	}

	buffer_clear();
}

// set all buffer values to 0x00
void buffer_init(void){
	
	for(uint8_t i = 0x00; i < NUM_MATRICIES*NUM_COLUMNS; i++){
		buffer[i] = 0x00;
	}
	
}

// set all buffer values to 0x00
void buffer_clear(void){
	
	for(uint8_t i = 0x00; i < NUM_MATRICIES*NUM_COLUMNS; i++){
		buffer[i] = 0x00;
	}

}

// add val at the end of buffer
void buffer_push(uint8_t val){
	
	for (uint8_t i = 0; i < (NUM_MATRICIES*NUM_COLUMNS - 1); i++){
			//move every byte over by one
			buffer[i] = buffer[i+1];
	}
	
	//add new byte at the end
	buffer[NUM_MATRICIES*NUM_COLUMNS - 1] = val;
	
}

void buffer_shift(void){
	//
	//
	for(uint8_t i = 0; i < (NUM_COLUMNS*NUM_MATRICIES) - NUM_COLUMNS; i++){
		buffer[i]= (buffer[i] << 1) | (buffer[i+NUM_COLUMNS] >> 7);

	}


	for(uint8_t i = (NUM_COLUMNS*NUM_MATRICIES) - NUM_COLUMNS; i < (NUM_COLUMNS*NUM_MATRICIES); i++){
		buffer[i]= (buffer[i] << 1) | (buffer[i - ((NUM_COLUMNS*NUM_MATRICIES) - NUM_COLUMNS)] >> 7);
	
	}

}

void matrix_push_char(uint8_t val){
	
}

void matrix_push_str(char * val){
	
}

void matrix_display_buffer(void){
	for (uint8_t i = 0x00; i < NUM_MATRICIES; i++){
		for (uint8_t j = 0x01; j < NUM_COLUMNS+1; j++){
		
			spi_clear_ss();			
			for (uint8_t k = 0x00; k < i; k++){
				spi_write_register(0x00, 0x00);
			}
						
			spi_write_register(j, buffer[j + i * NUM_COLUMNS - 1]);
						
			for (uint8_t k = NUM_MATRICIES-1; k > i; k--){
				spi_write_register(0x00, 0x00);
			}
						
			spi_set_ss();
						
		}
					
	}
				
	_delay_ms(TRANSMIT_DELAY_MS);
	
}
